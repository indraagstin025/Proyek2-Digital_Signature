<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer with Signature</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.11/interact.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #pdf-container {
            position: relative;
            width: 80%; /* Menyesuaikan ukuran tampilan PDF */
            max-width: 900px; /* Batas maksimal ukuran PDF */
            margin-bottom: 20px;
            background-color: white;
            border: 1px solid #ddd;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        #qrWrapper {
            position: absolute;
            z-index: 100;
            display: none;
            border: 2px dashed #4a5568;
            background-color: rgba(255, 255, 255, 0.8);
            cursor: move;
        }

        #qrWrapper img {
            width: 100%;
            height: 100%;
        }

        .navigation {
            display: flex;
            justify-content: space-around;
            width: 80%;
            max-width: 900px;
            margin: 20px 0;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="pdf-container">
        <canvas id="pdf-render"></canvas>
        <div id="qrWrapper" class="resize">
            <img id="qrImage" src="" alt="QR Code">
        </div>
    </div>

    <!-- Navigasi -->
    <div class="navigation">
        <button id="prev">← Halaman Sebelumnya</button>
        <button id="next">Halaman Berikutnya →</button>
        <button id="save-qr-settings">Simpan Posisi QR</button>
    </div>

    <!-- Status Halaman -->
    <div class="status">
        Halaman: <span id="page-num">1</span> / <span id="page-count"></span>
    </div>

    <script>
        const pdfjsLib = window["pdfjs-dist/build/pdf"];
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

        let pdfDoc = null,
            pageNum = 1,
            scale = 1.5; // Skala untuk menyesuaikan tampilan PDF
        const pdfCanvas = document.getElementById("pdf-render");
        const pdfCtx = pdfCanvas.getContext("2d");
        const qrWrapper = document.getElementById("qrWrapper");

        const renderPage = (num) => {
            pdfDoc.getPage(num).then((page) => {
                const viewport = page.getViewport({ scale });

                // Menyesuaikan ukuran canvas dengan viewport
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;

                const renderCtx = {
                    canvasContext: pdfCtx,
                    viewport: viewport,
                };

                page.render(renderCtx).promise.then(() => {
                    renderSavedQRPosition(viewport.width, viewport.height);
                });

                document.getElementById("page-num").textContent = num;
            });
        };

        const queueRenderPage = (num) => {
            if (num <= 0 || num > pdfDoc.numPages) return;
            renderPage(num);
        };

        // Navigasi Halaman
        document.getElementById("prev").addEventListener("click", () => {
            if (pageNum <= 1) return;
            pageNum--;
            renderPage(pageNum);
        });

        document.getElementById("next").addEventListener("click", () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            renderPage(pageNum);
        });

        // Load PDF
        const url = "{{ url_for('static', filename='uploads/' ~ document.filename) }}";
        pdfjsLib.getDocument(url).promise.then((pdfDoc_) => {
            pdfDoc = pdfDoc_;
            document.getElementById("page-count").textContent = pdfDoc.numPages;
            renderPage(pageNum);
        });

        // Drag-and-drop QR Code
        interact("#qrWrapper")
            .draggable({
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: "#pdf-container",
                        endOnly: true,
                    }),
                ],
                listeners: {
                    move(event) {
                        const target = event.target;
                        const x = (parseFloat(target.getAttribute("data-x")) || 0) + event.dx;
                        const y = (parseFloat(target.getAttribute("data-y")) || 0) + event.dy;

                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute("data-x", x);
                        target.setAttribute("data-y", y);
                    },
                },
            })
            .resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                modifiers: [
                    interact.modifiers.restrictEdges({
                        outer: "#pdf-container",
                    }),
                    interact.modifiers.restrictSize({
                        min: { width: 50, height: 50 },
                        max: { width: 300, height: 300 },
                    }),
                ],
                listeners: {
                    move(event) {
                        const target = event.target;
                        let x = parseFloat(target.getAttribute("data-x")) || 0;
                        let y = parseFloat(target.getAttribute("data-y")) || 0;

                        target.style.width = `${event.rect.width}px`;
                        target.style.height = `${event.rect.height}px`;

                        x += event.deltaRect.left;
                        y += event.deltaRect.top;

                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute("data-x", x);
                        target.setAttribute("data-y", y);
                    },
                },
            });

        // Simpan Posisi QR Code
        document.getElementById("save-qr-settings").addEventListener("click", async () => {
            const x = parseFloat(qrWrapper.getAttribute("data-x")) || 0;
            const y = parseFloat(qrWrapper.getAttribute("data-y")) || 0;
            const width = qrWrapper.offsetWidth;
            const height = qrWrapper.offsetHeight;
            const documentHash = "{{ document.doc_hash }}";
            const targetPage = pageNum - 1;

            const backendWidth = 595.28;
            const backendHeight = 841.89;

            const scaleX = backendWidth / pdfCanvas.width;
            const scaleY = backendHeight / pdfCanvas.height;

            const backendX = x * scaleX;
            const backendY = backendHeight - (y + height) * scaleY;
            const backendWidthQR = width * scaleX;
            const backendHeightQR = height * scaleY;

            try {
                const response = await fetch("/signature/save-qr-settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        document_hash: documentHash,
                        x: backendX,
                        y: backendY,
                        width: backendWidthQR,
                        height: backendHeightQR,
                        target_page: targetPage,
                    }),
                });

                const result = await response.json();
                if (response.ok) {
                    alert("Posisi QR Code berhasil disimpan!");
                } else {
                    alert(result.error || "Gagal menyimpan posisi QR Code.");
                }
            } catch (error) {
                console.error("Kesalahan saat menyimpan posisi QR Code:", error);
            }
        });

        // Render Posisi QR Code
        const renderSavedQRPosition = async (canvasWidth, canvasHeight) => {
            try {
                const response = await fetch(`/signature/get-token/{{ document.doc_hash }}`);
                const result = await response.json();

                if (response.ok) {
                    const { qr_position_x, qr_position_y, qr_width, qr_height } = result;

                    const backendWidth = 595.28;
                    const backendHeight = 841.89;

                    const scaleX = canvasWidth / backendWidth;
                    const scaleY = canvasHeight / backendHeight;

                    const xTransformed = qr_position_x * scaleX;
                    const yTransformed = canvasHeight - (qr_position_y + qr_height) * scaleY;
                    const widthTransformed = qr_width * scaleX;
                    const heightTransformed = qr_height * scaleY;

                    qrWrapper.style.transform = `translate(${xTransformed}px, ${yTransformed}px)`;
                    qrWrapper.style.width = `${widthTransformed}px`;
                    qrWrapper.style.height = `${heightTransformed}px`;

                    qrWrapper.setAttribute("data-x", xTransformed);
                    qrWrapper.setAttribute("data-y", yTransformed);
                    qrWrapper.classList.remove("hidden");
                } else {
                    console.error("Gagal mengambil posisi QR Code:", result.error);
                }
            } catch (error) {
                console.error("Kesalahan saat mengambil posisi QR Code:", error);
            }
        };
    </script>
</body>
</html>
